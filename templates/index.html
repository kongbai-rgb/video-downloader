<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>视频下载</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: #f5f5f7;
            font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        .container {
            background: #fff;
            border-radius: 24px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 48px 32px 32px 32px;
            min-width: 340px;
            max-width: 90vw;
            text-align: center;
            margin-top: 60px;
        }
        h1 {
            font-size: 2.2rem;
            font-weight: 700;
            color: #1d1d1f;
            margin-bottom: 32px;
            letter-spacing: 1px;
        }
        .input-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }
        .input-group {
            display: flex;
            align-items: center;
            position: relative;
            /* 拖拽区域样式 */
            border: 2px dashed #d2d2d7;
            transition: border-color 0.2s;
        }
        .input-group.dragover {
            border-color: #0071e3;
            background: #f0f8ff;
        }
        input[type="text"] {
            width: 420px;
            max-width: 90vw;
            padding: 14px 40px 14px 16px;
            border: 1px solid #d2d2d7;
            border-radius: 12px;
            font-size: 1rem;
            outline: none;
            transition: border 0.2s;
            background: #f5f5f7;
        }
        input[type="text"]:focus {
            border: 1.5px solid #0071e3;
            background: #fff;
        }
        .clear-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #e0e0e0;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.1rem;
            color: #888;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
        }
        .clear-btn:active, .download-btn:active {
            background: #0071e3;
            color: #fff;
            box-shadow: 0 2px 8px rgba(0,113,227,0.10);
        }
        button.download-btn {
            padding: 12px 36px;
            background: #1d1d1f;
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: background 0.2s, box-shadow 0.2s, color 0.2s;
        }
        button.download-btn:hover {
            background: #1d1d1f;
            color: #fff;
            box-shadow: 0 4px 16px rgba(0,113,227,0.08);
        }
        button.download-btn:active {
            background: #005bb5;
            color: #fff;
            box-shadow: 0 2px 8px rgba(0,113,227,0.10);
        }
        #result {
            margin-top: 28px;
            font-size: 1.1rem;
            color: #0071e3;
            min-height: 24px;
        }
        @media (max-width: 600px) {
            .container {
                padding: 24px 8px 16px 8px;
                min-width: unset;
            }
            h1 {
                font-size: 1.3rem;
            }
            .input-row {
                flex-direction: column;
                gap: 8px;
            }
            .input-group input[type="text"] {
                width: 90vw;
                font-size: 0.95rem;
            }
            button.download-btn {
                font-size: 1rem;
                padding: 10px 18px;
                width: 100%;
            }
        }
        .xlsx-list {
            margin-top: 18px;
            text-align: left;
            max-height: 220px;
            overflow-y: auto;
            background: #fafbfc;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            padding: 10px 18px;
            font-size: 15px;
        }
        .xlsx-link {
            color: #0071e3;
            word-break: break-all;
            margin-bottom: 8px;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>视频下载</h1>
        <div class="input-row">
            <div class="input-group" id="drop-area">
                <input type="text" id="url" placeholder="请输入视频链接">
                <button class="clear-btn" onclick="clearInput()" title="清除">×</button>
                <input type="file" id="xlsx-input" accept=".xlsx" style="display:none;">
            </div>
            <button class="download-btn" onclick="download()">下载</button>
            <button class="download-btn" style="background:#888;" onclick="readXlsx()">读取</button>
        </div>
        <div id="xlsx-list" class="xlsx-list" style="display:none;"></div>
        <p id="result"></p>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        function clearInput() {
            document.getElementById('url').value = '';
            document.getElementById('url').focus();
        }
        function download() {
            const url = document.getElementById('url').value;
            if (!confirm('确定要下载该视频吗？')) {
                return;
            }
            // 先请求后端准备下载
            fetch('/download', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({url})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // 显示进度条
                    showProgressBar();
                    // 用XHR下载文件并显示进度
                    xhrDownload(data.download_url);
                }
            });
        }
        function showProgressBar() {
            let bar = document.getElementById('progress-bar');
            let box = document.getElementById('progress-box');
            if (!bar) {
                box = document.createElement('div');
                box.id = 'progress-box';
                box.style.width = '420px';
                box.style.margin = '0 auto 16px auto';
                box.style.background = '#eee';
                box.style.borderRadius = '8px';
                box.style.overflow = 'hidden';
                box.style.height = '18px';
                bar = document.createElement('div');
                bar.id = 'progress-bar';
                bar.style.height = '100%';
                bar.style.width = '0%';
                bar.style.background = '#0071e3';
                bar.style.transition = 'width 0.2s';
                bar.style.textAlign = 'center';
                bar.style.color = '#fff';
                bar.style.fontSize = '12px';
                bar.style.lineHeight = '18px';
                box.appendChild(bar);
                document.querySelector('.container').insertBefore(box, document.querySelector('.input-row').nextSibling);
            } else {
                bar.style.width = '0%';
                bar.innerText = '0%';
                box.style.display = '';
            }
        }
        function hideProgressBar() {
            let box = document.getElementById('progress-box');
            if (box) box.style.display = 'none';
        }
        function xhrDownload(url) {
            let xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.responseType = 'blob';
            xhr.onprogress = function(e) {
                if (e.lengthComputable) {
                    let percent = Math.floor(e.loaded / e.total * 100);
                    let bar = document.getElementById('progress-bar');
                    if (bar) {
                        bar.style.width = percent + '%';
                        bar.innerText = percent + '%';
                    }
                }
            };
            xhr.onload = function() {
                if (xhr.status === 200) {
                    let bar = document.getElementById('progress-bar');
                    if (bar) {
                        bar.style.width = '100%';
                        bar.innerText = '100%';
                    }
                    // 下载文件
                    let filename = '';
                    let disposition = xhr.getResponseHeader('Content-Disposition');
                    if (disposition && disposition.indexOf('filename=') !== -1) {
                        filename = decodeURIComponent(disposition.split('filename=')[1].replace(/['"]/g, ''));
                    } else {
                        filename = 'video.mp4';
                    }
                    let blob = xhr.response;
                    let link = document.createElement('a');
                    link.href = window.URL.createObjectURL(blob);
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    setTimeout(hideProgressBar, 1000);
                } else {
                    hideProgressBar();
                }
            };
            xhr.onerror = function() {
                hideProgressBar();
            };
            xhr.send();
        }
        // 拖拽支持（增强：支持xlsx文件）
        const dropArea = document.getElementById('drop-area');
        const urlInput = document.getElementById('url');
        dropArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            dropArea.classList.add('dragover');
        });
        dropArea.addEventListener('dragleave', function(e) {
            dropArea.classList.remove('dragover');
        });
        dropArea.addEventListener('drop', function(e) {
            e.preventDefault();
            dropArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                if (file.name.endsWith('.xlsx')) {
                    // 读取xlsx文件
                    const reader = new FileReader();
                    reader.onload = function(evt) {
                        const data = new Uint8Array(evt.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        let links = [];
                        workbook.SheetNames.forEach(function(sheetName) {
                            const sheet = workbook.Sheets[sheetName];
                            const range = XLSX.utils.decode_range(sheet['!ref']);
                            for (let R = range.s.r; R <= range.e.r; ++R) {
                                for (let C = range.s.c; C <= range.e.c; ++C) {
                                    const cell = sheet[XLSX.utils.encode_cell({r:R, c:C})];
                                    if (cell && typeof cell.v === 'string' && (cell.v.startsWith('http://') || cell.v.startsWith('https://'))) {
                                        links.push(cell.v);
                                    }
                                }
                            }
                        });
                        showLinks(links);
                    };
                    reader.readAsArrayBuffer(file);
                    return;
                }
                // 其他文件类型（如txt）
                const reader = new FileReader();
                reader.onload = function(evt) {
                    urlInput.value = evt.target.result;
                };
                reader.readAsText(file);
                return;
            }
            // 拖拽文本
            if (e.dataTransfer.items) {
                for (let i = 0; i < e.dataTransfer.items.length; i++) {
                    if (e.dataTransfer.items[i].kind === 'string') {
                        e.dataTransfer.items[i].getAsString(function(str) {
                            urlInput.value = str;
                        });
                        return;
                    }
                }
            }
        });
        function readXlsx() {
            const urlValue = document.getElementById('url').value.trim();
            if (urlValue && urlValue.endsWith('.xlsx')) {
                // 尝试读取本地xlsx文件（仅本地环境下可用，浏览器安全限制）
                fetch(urlValue)
                    .then(res => res.arrayBuffer())
                    .then(buffer => {
                        const data = new Uint8Array(buffer);
                        const workbook = XLSX.read(data, {type: 'array'});
                        let links = [];
                        workbook.SheetNames.forEach(function(sheetName) {
                            const sheet = workbook.Sheets[sheetName];
                            const range = XLSX.utils.decode_range(sheet['!ref']);
                            for (let R = range.s.r; R <= range.e.r; ++R) {
                                for (let C = range.s.c; C <= range.e.c; ++C) {
                                    const cell = sheet[XLSX.utils.encode_cell({r:R, c:C})];
                                    if (cell && typeof cell.v === 'string' && (cell.v.startsWith('http://') || cell.v.startsWith('https://'))) {
                                        links.push(cell.v);
                                    }
                                }
                            }
                        });
                        showLinks(links);
                    })
                    .catch(() => {
                        alert('无法读取该xlsx文件，请确保路径正确且允许被访问');
                    });
            } else {
                document.getElementById('xlsx-input').value = '';
                document.getElementById('xlsx-input').click();
            }
        }
        document.getElementById('xlsx-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                const data = new Uint8Array(evt.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                let links = [];
                workbook.SheetNames.forEach(function(sheetName) {
                    const sheet = workbook.Sheets[sheetName];
                    const range = XLSX.utils.decode_range(sheet['!ref']);
                    for (let R = range.s.r; R <= range.e.r; ++R) {
                        for (let C = range.s.c; C <= range.e.c; ++C) {
                            const cell = sheet[XLSX.utils.encode_cell({r:R, c:C})];
                            if (cell && typeof cell.v === 'string' && (cell.v.startsWith('http://') || cell.v.startsWith('https://'))) {
                                links.push(cell.v);
                            }
                        }
                    }
                });
                showLinks(links);
            };
            reader.readAsArrayBuffer(file);
        });
        function showLinks(links) {
            const list = document.getElementById('xlsx-list');
            if (links.length === 0) {
                list.style.display = 'none';
                list.innerHTML = '';
                return;
            }
            list.style.display = '';
            list.innerHTML = links.map(link => `<span class='xlsx-link'>${link}</span>`).join('');
        }
    </script>
</body>
</html>
